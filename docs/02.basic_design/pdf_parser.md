# PDF解析機能 基本設計書

## 1. 概要

企業の決算短信PDFから必要な情報を抽出するための機能を提供します。
LLMを活用して動的に解析を行い、構造化されたデータとして保存します。

## 2. 基本方針

1. 解析アプローチ
   - PDFをテキストとして抽出
   - LLMを使用して必要な情報を特定
   - 構造化データとしてJSON形式で保存

2. 使用技術
   - PDF抽出: `pdfplumber`
   - LLM: OpenAI GPT-4
   - データ保存: JSON

## 3. 機能要件

### 3.1 必須機能
1. PDF解析機能
   - PDFからのテキスト抽出
   - ページ単位での処理
   - テーブル構造の認識

2. LLMによる情報抽出
   - 財務情報の特定と抽出
   - 数値データの正規化
   - 時系列データの関連付け

3. データ構造化
   - 統一されたJSON形式での出力
   - データの検証と正規化
   - メタデータの付与

### 3.2 抽出対象情報
1. 財務情報
   - 売上高
   - 営業利益
   - 経常利益
   - 当期純利益
   - 1株当たり情報
   - セグメント情報

2. 業績予想
   - 次期の業績予想
   - 予想の前提条件

3. 経営指標
   - ROE
   - ROA
   - 自己資本比率

## 4. システム構成

### 4.1 モジュール構成
```
app/
├── parser/
│   ├── __init__.py
│   ├── base.py          # 基本パーサークラス
│   ├── pdf.py           # PDF処理クラス
│   ├── llm.py          # LLM連携クラス
│   └── normalizer.py    # データ正規化クラス
```

### 4.2 クラス構成
1. `BaseParser`
   - パーサーの基本機能を提供
   - 共通のインターフェースを定義

2. `PDFParser`
   - PDFファイルの読み込み
   - テキスト抽出処理
   - ページ管理

3. `LLMAnalyzer`
   - LLMとの通信
   - プロンプト管理
   - 結果の解析

4. `DataNormalizer`
   - データの正規化
   - 形式の統一化
   - バリデーション

## 5. データ形式

### 5.1 出力JSON形式
```json
{
  "document_info": {
    "title": "2024年2月期 第3四半期決算短信",
    "company": "株式会社ニトリホールディングス",
    "date": "2024-01-XX",
    "period": "2024Q3"
  },
  "financial_data": {
    "revenue": {
      "value": 1000000000,
      "unit": "百万円",
      "year_on_year": 1.05
    },
    "operating_income": {
      "value": 100000000,
      "unit": "百万円",
      "year_on_year": 0.98
    }
  },
  "metadata": {
    "parsed_at": "2024-03-XX",
    "parser_version": "1.0.0",
    "confidence_score": 0.95
  }
}
```

## 6. エラー処理

1. PDF処理エラー
   - ファイル読み込みエラー
   - テキスト抽出エラー
   - 形式不正エラー

2. LLM処理エラー
   - API通信エラー
   - 解析失敗エラー
   - タイムアウトエラー

3. データ処理エラー
   - 形式不正エラー
   - バリデーションエラー
   - 保存エラー

## 7. 性能要件

1. 処理時間
   - 1ファイルあたり5分以内
   - LLM APIのタイムアウト: 60秒

2. 精度要件
   - 数値の抽出精度: 99%以上
   - テキストの認識精度: 95%以上

3. スケーラビリティ
   - 並列処理対応
   - バッチ処理対応

## 8. セキュリティ要件

1. データ保護
   - 機密情報の適切な管理
   - アクセス制御の実装

2. API認証
   - APIキーの安全な管理
   - 環境変数での設定

3. エラーログ
   - 機密情報の非表示
   - 適切なログレベル設定 