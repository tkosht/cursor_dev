# プロジェクト知識ベース

## 1. 外部サービス接続管理

### Neo4j接続管理
#### スコープ
- Neo4jデータベース接続処理
- 環境変数管理
- セッション管理

#### 知識内容
1. 環境変数の適切な取り扱い方法
   - python-dotenvを使用した.envファイルの読み込み
   - 環境変数の存在確認と型変換の実装
   - 必須環境変数のバリデーション処理

2. テスト環境と本番環境の設定分離
   - .env.test と .env の使い分け
   - テスト用の認証情報の安全な管理
   - 環境別の接続設定の分離

3. セッション管理のベストプラクティス
   - コンテキストマネージャーの活用
   - リソースの適切な解放
   - コネクションプールの管理

#### 再利用場面
- 新規データベース接続の実装時
- テスト環境のセットアップ時
- セッション管理の実装時

### Gemini API連携
#### スコープ
- API認証
- レスポンス処理
- エラーハンドリング

#### 知識内容
1. API認証管理
   - APIキーのバリデーション
   - 認証エラーの適切な処理
   - キーローテーションへの対応

2. レスポンス処理
   - 非同期処理の実装
   - タイムアウト設定
   - エラーレスポンスのハンドリング

#### 再利用場面
- 新規API連携の実装時
- 認証機能の実装時
- エラーハンドリングの設計時

## 2. エラーハンドリング

### 環境変数管理
#### スコープ
プロジェクト全体の環境変数管理

#### 知識内容
1. 発生した問題
   - KeyError: 'NEO4J_URI'
   - 環境変数の読み込みタイミングの問題
   - テスト環境での設定値の取り扱い

2. 解決策
   - 共通ユーティリティ関数の作成
   - 環境変数読み込みの初期化処理の改善
   - バリデーション機能の実装

3. 再発防止策
   - 環境変数チェックリストの作成
   - 起動時の検証処理の追加
   - ログ出力の強化

#### 再利用場面
- 設定ファイルの読み込み実装時
- 環境変数の追加時
- テスト環境のセットアップ時

### エンコーディング処理
#### スコープ
コンテンツパーサーモジュール

#### 知識内容
1. 発生した問題
   - SHIFT-JISエンコーディングの処理エラー
   - 不正なエンコーディングのハンドリング
   - UnicodeDecodeError の発生

2. 解決策
   - chardetライブラリの導入
   - フォールバックエンコーディングの実装
   - try-except による例外処理の追加

3. 再発防止策
   - エンコーディング検出ロジックの改善
   - テストケースの追加
   - エラーログの詳細化

#### 再利用場面
- テキスト処理機能の実装時
- 文字コード変換処理の実装時
- 国際化対応の実装時

## 3. セキュリティ対策

### 認証情報管理
#### スコープ
- 環境変数
- APIキー
- データベース認証情報

#### 知識内容
1. 環境変数による認証情報管理
   - .env ファイルの適切な配置
   - gitignore への追加
   - 環境別の設定ファイル管理

2. APIキーのバリデーションと保護
   - 形式チェックの実装
   - 有効期限管理
   - セキュアな保存方法

3. データベース認証情報の保護
   - コネクションプールの適切な設定
   - タイムアウト設定
   - リトライ処理の実装

#### 再利用場面
- 認証機能の実装時
- 外部サービス連携時
- セキュリティ監査時

## Gemini APIテスト設計のベストプラクティス

### スコープ
- app/gemini_analyzer.py
- tests/test_gemini_analyzer.py

### 知識内容
1. 実環境テストの重要性
   - モックを使用せず、実際のAPIエンドポイントに対してテストを実施
   - 実際のレスポンス形式や遅延、エラーケースを確認可能
   - 本番環境での動作を事前に検証可能

2. エラーケースの網羅的テスト
   - APIキーの不正・未設定
   - 不正な入力形式
   - JSONパースエラー
   - 必須フィールドの欠落
   - 値の範囲チェック（0.0-1.0など）

3. JSONレスポンスの適切な検証方法
   - 必須フィールドの存在確認
   - 値の型チェック
   - 値の範囲チェック
   - ネストされたオブジェクトの構造確認

### 再利用場面
- 外部APIを利用する他のコンポーネントのテスト実装時
- レスポンスの形式が複雑なAPIのテスト設計時
- エラーハンドリングの設計時

## 市場分析テストのベストプラクティス

### スコープ
- app/market_analyzer.py
- tests/test_market_analyzer.py

### 知識内容
1. エンティティ抽出の検証方法
   - 必須フィールド（name, type）の存在確認
   - 型の大文字変換（COMPANY, PRODUCT等）の検証
   - オプショナルフィールド（description, properties）の処理確認
   - 不正なデータ構造のハンドリング

2. リレーションシップ検出の検証方法
   - 必須フィールド（type, source, target）の存在確認
   - 型の大文字変換（INFLUENCES, COMPETES等）の検証
   - オプショナルフィールド（description, properties）の処理確認
   - 不正なデータ構造のハンドリング

3. 影響度スコアの検証方法
   - 数値範囲の検証（0.0-1.0）
   - 文字列からの型変換
   - 不正な値（範囲外、不正な型）のハンドリング
   - 複数の影響度スコア（market, technology, social）の処理

### 再利用場面
- 新しい分析機能の実装時
- データ構造の検証が必要な場合
- スコアリングシステムの実装時

# 環境変数の管理

## 環境変数ファイルの使い分け

### 対象スコープ
- プロジェクト全体の環境変数管理

### 知識内容
1. 環境変数ファイルの種類と用途
   - `.env`: 本番環境用の環境変数ファイル
   - `.env.test`: テスト環境用の環境変数ファイル

2. 使い分けのルール
   - テスト実行時: `.env.test` を使用
   - 本番実行時: `.env` を使用

3. 重要な設定値
   - Neo4j接続情報
     - NEO4J_URI: Neo4jサーバーのURI
     - neo4j_user: Neo4jのユーザー名
     - neo4j_pswd: Neo4jのパスワード
   - Gemini API
     - GOOGLE_API_KEY_GEMINI: GeminiのAPIキー

### 今後の再利用場面
- テストコード実装時の環境変数設定
- CI/CD環境での環境変数管理
- 新規機能追加時の環境変数設定 

# 知識ベース

## データベース操作

### エラーハンドリング
- データベース操作では、エラーを適切に処理し、上位層に伝播させることが重要
- エラーメッセージは具体的で、問題の原因を特定できるものにする必要がある
- エラーが発生した場合は、部分的な更新を防ぐために例外を再送出する

### トランザクション管理
- データベース操作では、一連の操作が失敗した場合に適切にロールバックする必要がある
- エラーが発生した場合は、部分的な更新を防ぐために例外を再送出する
- トランザクションの境界を明確にし、ACID特性を維持する

## テスト

### テストカバレッジ
- エラーケースのテストは、システムの堅牢性を確保するために重要
- 境界値テストやエッジケースのテストも必要
- テストカバレッジは、コードの品質を測る一つの指標として有用

### モック
- 外部依存のあるテストでは、モックを使用して依存を分離する
- モックは、テスト対象のコードが期待通りに動作することを確認するために使用
- モックは、実際のオブジェクトの振る舞いを模倣する必要がある 

# 開発知識ベース

## テスト設計・実装

### テストケース設計のベストプラクティス
- メソッドの引数仕様を事前に十分確認し、インターフェースの整合性を確保する
- バリデーションテストでは、型チェックだけでなく、値の範囲や形式も厳密にチェックする
- モッキングが必要な場合は、依存関係を明示的に管理する（例：pyproject.tomlでの指定）

### テスト実行環境の整備
- pytest-mockなどの依存ライブラリは、pyproject.tomlの[tool.poetry.group.dev.dependencies]セクションで管理
- 環境変数は.env.testファイルで管理し、テスト時に適切に読み込む
- 結合テストではモックを使用せず、実際のサービスとの疎通を確認する

## エラー対応

### バリデーションエラー対応
- メソッドの引数不足エラーが発生した場合：
  1. メソッドのインターフェース定義を確認
  2. 呼び出し側のコードを修正
  3. テストケースも合わせて修正
- バリデーションロジックが不十分な場合：
  1. 型チェックを実装
  2. 値の範囲チェックを実装
  3. 形式（フォーマット）チェックを実装
  4. エッジケースのテストを追加

### 未実装メソッドエラー対応
- AttributeError（メソッド未実装）が発生した場合：
  1. クラスの責務を再確認
  2. 必要なメソッドを実装
  3. インターフェースの一貫性を確保
  4. 単体テストを追加

## 実装パターン

### バリデーション実装パターン
- 入力値の検証は以下の順序で実施：
  1. 必須パラメータの存在確認
  2. 型チェック
  3. 値の範囲・形式チェック
  4. ビジネスルールに基づく妥当性チェック

### データベース操作パターン
- Neo4jでのエンティティ操作：
  1. 既存エンティティの存在確認
  2. トランザクション開始
  3. CRUD操作の実行
  4. エラー発生時のロールバック
  5. 成功時のコミット

## セキュリティ対策

### 環境変数管理
- 本番環境用の.envと、テスト環境用の.env.testを分離
- 環境変数の値は直接コードに記載しない
- os.getenv()を使用して安全に取得

### データベースセキュリティ
- クエリパラメータバインディングを必ず使用
- パスワードなどの機密情報はログに出力しない
- 接続情報は環境変数で管理 