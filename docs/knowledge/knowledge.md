# プロジェクト知識ベース

## メトリクス管理システム
### 対象スコープ
- app/llm/base.py の LLMMetrics クラス
- app/metrics/url_analysis_metrics.py のメトリクス関連機能

### 知識内容
1. エラー発生時のメトリクス更新ルール
   - プロンプトのトークン数は記録を継続
   - 完了トークン数は0として記録
   - エラーカウントは累積で記録
   - リセット操作時にすべての値をクリア

2. 重要な設定値
   - エラーカウントの初期値: 0
   - トークンカウントの初期値: 0
   - 処理時間の初期値: 0.0

### 再利用場面
- 新しいLLMクライアントの実装時
- メトリクス収集システムの拡張時
- エラーレート監視機能の実装時

## エラーハンドリングシステム
### 対象スコープ
- app/llm/gemini.py のエラー処理
- app/errors/url_analysis_errors.py のエラー定義

### 知識内容
1. エラー処理の基本方針
   - 空のコンテンツ入力: 専用のエラーメッセージを返却
   - APIエラー: エラーカウント増加後に例外を再送出
   - リトライ処理: 各試行でエラーカウントを個別にカウント

2. 実装上の重要ポイント
   - エラーメッセージは具体的で対処方法を含める
   - エラー発生箇所のコンテキスト情報を保持
   - リトライ可能なエラーとそうでないものを区別

### 再利用場面
- 新しいAPIクライアントの実装時
- エラー処理システムの拡張時
- リトライ機構の実装時

## テスト設計パターン
### 対象スコープ
- tests/llm/test_gemini.py
- tests/integration/test_real_urls.py
- tests/unit/test_url_analysis_errors.py

### 知識内容
1. テスト実装の基本方針
   - 外部API: モックオブジェクトでシミュレート
   - 非同期処理: asyncio.Future を活用
   - エッジケース: 明確な期待値を定義

2. カバレッジ目標値
   - 単体テスト: 90%以上
   - 統合テスト: 80%以上
   - 重要なエッジケース: 100%

### 再利用場面
- 新機能のテストコード作成時
- テストカバレッジ改善時
- CI/CDパイプラインの構築時

## テスト実行環境の管理
### 対象スコープ
- tests/ ディレクトリ全体
- pytest-asyncio の設定
- テストデータベースの管理

### 知識内容
1. 非同期テストの実行環境
   - イベントループは適切なライフサイクル管理が必要
   - pytest-asyncioの設定でイベントループの再利用を検討
   - テストケース間でのイベントループの独立性確保

2. データベーステストの前提条件
   - テスト実行前にマイグレーション状態の確認が必須
   - テストデータベースの初期化手順の明確化
   - トランザクション管理の統一的なアプローチ

3. モックサーバーの設定
   - 応答時間の適切な設定
   - エラーケースの網羅的なシミュレーション
   - 実際のAPIレスポンスに近い挙動の再現

### 再利用場面
- 新規テストケース追加時
- CI/CD環境のセットアップ時
- テスト実行環境の問題解決時

## カバレッジ管理方針
### 対象スコープ
- app/ ディレクトリ全体のテストカバレッジ
- 特に改善が必要な低カバレッジモジュール

### 知識内容
1. カバレッジ目標
   - プロジェクト全体で最低70%を目指す
   - 重要なビジネスロジックは90%以上
   - エラーハンドリングは100%のカバレッジ

2. 優先的に改善が必要な領域
   - LLM関連モジュール（特にGemini実装）
   - エラーハンドリングモジュール
   - メトリクス収集モジュール

3. カバレッジ改善戦略
   - エッジケースのテスト追加
   - 例外パスのテスト強化
   - 統合テストでのシナリオ網羅

### 再利用場面
- コードレビュー時のチェックポイント
- リファクタリング時の品質確認
- 新機能追加時のテスト設計

## エラーハンドリング設計
### 対象スコープ
- app/errors/ ディレクトリ
- 各モジュールのエラー処理

### 知識内容
1. エラーメッセージの標準化
   - フォーマットの統一
   - 多言語対応（日本語・英語）
   - エラーコードの体系化

2. タイムアウト設定
   - 適切なタイムアウト値の設定
   - リトライ戦略の実装
   - デッドロック防止の仕組み

3. 例外処理の設計
   - 例外の階層構造の整理
   - ログ出力レベルの基準
   - エラーリカバリーのフロー

### 再利用場面
- 新規エラーケース追加時
- エラー処理のリファクタリング時
- 運用監視の設計時

## データベース関連

### SQLAlchemyの基本設定
- テーブル作成は`Base.metadata.create_all(engine)`を使用する
- テスト用DBは別ファイルを使用し、テスト後に削除する
- モデルには`__tablename__`を明示的に指定する

### テスト設計のベストプラクティス
- テストが複雑化・肥大化した場合は、一度すべて削除して基本的なものから作り直すことも検討する
- テストケースは独立性を保ち、他のテストの影響を受けないようにする
- テストデータは最小限に保ち、必要な属性のみを設定する

### モデル設計の注意点
- モデルのフィールドは、実際のユースケースに基づいて必要十分な形で定義する
- 必須フィールドには`nullable=False`を設定する
- ユニークな値には`unique=True`を設定する
- 文字列フィールドには適切な長さ制限を設定する 

## 企業情報抽出システム
### 対象スコープ
- app/site_analyzer.py の URLAnalyzer クラス
- app/llm/manager.py の LLMManager クラス
- tests/integration/test_company_info_extraction.py のテストケース

### 知識内容
1. コンテンツ抽出の最適化
   - BeautifulSoupによるHTML解析時は不要な要素（script, style, noscript）を事前に削除
   - テキスト抽出時は改行で区切り、空行を除去して整形
   - 長大なコンテンツは3000文字までに制限し、重要情報を優先的に抽出

2. エラーハンドリング戦略
   - ネットワークエラー、レート制限、タイムアウトを個別に処理
   - エラー発生時はモックデータを返してシステムの継続性を確保
   - エラー情報は処理時間やレイテンシと共に詳細に記録

3. LLMプロンプト設計
   - タスク別に最適化されたプロンプトを用意
   - 必須フィールド（企業名、事業内容、業界）を明確に指定
   - 出力形式をJSON形式で厳密に定義

### 再利用場面
- 新しい企業情報ソースの追加時
- 情報抽出システムの拡張時
- 類似のWebスクレイピングタスク実装時

## テスト設計パターン（更新）
### 対象スコープ
- tests/integration/test_company_info_extraction.py
- その他の統合テスト

### 知識内容
1. 実URLテストの設計
   - 代表的な企業サイトを選定（業界や規模を考慮）
   - 基本情報の抽出可能性を確認
   - データの永続化まで含めた一貫したテスト

2. エラーケースのカバレッジ
   - 存在しないURL
   - レート制限到達
   - ネットワークタイムアウト
   - 無効なレスポンス

3. データ検証の重要ポイント
   - 必須フィールドの存在確認
   - データ型の厳密な検証
   - 文字列長や内容の妥当性チェック

### 再利用場面
- 新規Webスクレイピング機能の実装時
- 統合テストの設計時
- エラーハンドリングの実装時 