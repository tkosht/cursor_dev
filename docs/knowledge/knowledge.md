# プロジェクト知識ベース

## メトリクス管理システム
### 対象スコープ
- app/llm/base.py の LLMMetrics クラス
- app/metrics/url_analysis_metrics.py のメトリクス関連機能

### 知識内容
1. エラー発生時のメトリクス更新ルール
   - プロンプトのトークン数は記録を継続
   - 完了トークン数は0として記録
   - エラーカウントは累積で記録
   - リセット操作時にすべての値をクリア

2. 重要な設定値
   - エラーカウントの初期値: 0
   - トークンカウントの初期値: 0
   - 処理時間の初期値: 0.0

### 再利用場面
- 新しいLLMクライアントの実装時
- メトリクス収集システムの拡張時
- エラーレート監視機能の実装時

## エラーハンドリングシステム
### 対象スコープ
- app/llm/gemini.py のエラー処理
- app/errors/url_analysis_errors.py のエラー定義

### 知識内容
1. エラー処理の基本方針
   - 空のコンテンツ入力: 専用のエラーメッセージを返却
   - APIエラー: エラーカウント増加後に例外を再送出
   - リトライ処理: 各試行でエラーカウントを個別にカウント

2. 実装上の重要ポイント
   - エラーメッセージは具体的で対処方法を含める
   - エラー発生箇所のコンテキスト情報を保持
   - リトライ可能なエラーとそうでないものを区別

### 再利用場面
- 新しいAPIクライアントの実装時
- エラー処理システムの拡張時
- リトライ機構の実装時

## テスト設計パターン
### 対象スコープ
- tests/llm/test_gemini.py
- tests/integration/test_real_urls.py
- tests/unit/test_url_analysis_errors.py

### 知識内容
1. テスト実装の基本方針
   - 外部API: モックオブジェクトでシミュレート
   - 非同期処理: asyncio.Future を活用
   - エッジケース: 明確な期待値を定義

2. カバレッジ目標値
   - 単体テスト: 90%以上
   - 統合テスト: 80%以上
   - 重要なエッジケース: 100%

### 再利用場面
- 新機能のテストコード作成時
- テストカバレッジ改善時
- CI/CDパイプラインの構築時 