# プロジェクト知識ベース

## 0. 設計ドキュメント参照
- 要件定義: `docs/01.requirements/adaptive_search.md`
  - 機能要件、非機能要件、インターフェース定義
  - エラー定義、制限事項、セキュリティ要件
  - 運用監視要件

- 基本設計: `docs/02.basic_design/adaptive_search.md`
  - システム構成、処理フロー
  - データ構造、インターフェース設計
  - 設定パラメータ、監視設計
  - セキュリティ設計、運用設計

- 詳細設計: `docs/03.detail_design/adaptive_search.md`
  - クラス詳細設計（各クラスの実装詳細）
  - 例外クラス設計
  - 設定ファイル定義
  - ログ設定、メトリクス定義
  - テスト設計、デプロイメント手順

## 1. 外部API

### 1.1 Google Custom Search API
- 環境変数:
  - `GOOGLE_API_KEY`: Google APIキー
  - `CSE_ID`: カスタム検索エンジンID
- 用途: IR情報の動的URL検索
- 制限:
  - 1日あたりのクエリ制限あり
  - レート制限あり
- 注意点:
  - APIキーは環境変数で管理
  - サイト制限を適切に設定
  - 検索結果の関連性スコアを評価

## 2. 実装パターン

### 2.1 再試行制御
- 指数バックオフを使用
- 最大試行回数を設定
- エラー状態を記録

### 2.2 非同期処理
- `asyncio`を使用
- タイムアウト制御
- リソース解放の保証

## 3. エラーハンドリング

### 3.1 一般的なエラー
- ネットワークエラー
- タイムアウト
- 認証エラー

### 3.2 特殊なエラー
- データ抽出失敗
- 検証失敗
- 最大試行回数超過

## 4. パフォーマンス最適化

### 4.1 キャッシュ戦略
- 検索結果のキャッシュ
- 抽出データのキャッシュ
- キャッシュの有効期限管理

### 4.2 並行処理
- URL並行処理
- データ抽出の並行化
- リソース制限の考慮

## 5. 監視とロギング

### 5.1 メトリクス
- 成功率
- レスポンス時間
- エラー率
- リソース使用率

### 5.2 ログレベル
- INFO: 通常の処理フロー
- WARNING: 再試行発生
- ERROR: 致命的エラー
- DEBUG: 詳細なデバッグ情報

# プロジェクトで得られた知識

## データ抽出
### セレクターベースの抽出
- **スコープ**: データ抽出機能全般
- **知識内容**:
  - CSSセレクターを使用した抽出が柔軟性が高い
  - 正規表現と組み合わせることで精度向上が可能
  - セレクターの設定を外部化することで、サイト構造の変更に対応しやすい
- **再利用場面**:
  - 新規サイトからのデータ抽出時
  - 既存抽出ロジックの保守時
  - 抽出精度の改善時

### データ検証スコアリング
- **スコープ**: データ検証機能
- **知識内容**:
  - 型一致による基本検証が有効
  - 部分的な正解も評価に含めることで、より現実的な評価が可能
  - 閾値（例：70%）による品質管理が効果的
- **再利用場面**:
  - データ品質の定量的評価時
  - 抽出結果の自動判定時
  - 品質改善の目標設定時

## テスト設計
### 効果的なテストケース構成
- **スコープ**: テストコード全般
- **知識内容**:
  - モックデータによる単体テストで基本機能を確認
  - 実データによる統合テストで実際の動作を確認
  - エラーケースを網羅的にテスト
- **再利用場面**:
  - 新機能のテスト設計時
  - テストカバレッジ改善時
  - リグレッションテスト設計時

### 非同期処理のテスト
- **スコープ**: 非同期機能のテスト
- **知識内容**:
  - 並行実行時の挙動確認が重要
  - レート制限などの制約をテストに組み込む
  - タイムアウト処理の確実な検証
- **再利用場面**:
  - 外部APIとの連携機能実装時
  - パフォーマンス要件の検証時
  - エラーハンドリングの実装時

## メトリクス収集
### スコープ
- メトリクス収集機能全般
- 処理時間計測
- 統計情報の管理

### 知識内容
1. コンテキストマネージャの活用
   - 処理時間の計測には`@contextmanager`デコレータを使用
   - 処理の開始・終了を自動的に検知可能
   - エラー発生時も確実に時間を記録

2. 時系列データの管理
   - タイムスタンプは常に明示的に指定可能に
   - デフォルトでは現在時刻を使用
   - 検索時は時間範囲を指定して取得

3. 統計情報の集計
   - 初期化時にデフォルト値を設定
   - 辞書のデフォルト値には`defaultdict`を活用
   - 集計時は分母が0の場合を考慮

### 再利用場面
- 処理時間の計測が必要な場合
- 時系列データの収集が必要な場合
- 統計情報の集計が必要な場合

## テスト設計のベストプラクティス
### スコープ
- テストコード全般
- 時間依存のテスト
- 統計値の検証

### 知識内容
1. 境界値テスト
   - 空データの処理を必ずテスト
   - 初期状態での動作を確認
   - エラーケースの網羅

2. 時間依存のテスト
   - 適切な待機時間を設定
   - 処理時間の許容範囲を考慮
   - タイムスタンプの比較は範囲指定

3. 統計値の検証
   - 厳密な値の比較は避ける
   - 許容範囲を持たせた判定
   - `pytest.approx`の活用

### 再利用場面
- 新規テストコード作成時
- 既存テストの改善時
- パフォーマンステストの実装時