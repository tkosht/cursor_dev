# GitHub Actions CI/CD仕様書

## 概要

本プロジェクトでは、GitHub Actionsを使用して継続的インテグレーション（CI）を実装しています。
全てのサブシステムに対してテストを実行し、コード品質を保証します。

## ワークフロー構成

### 1. メインCIワークフロー（ci.yml）

**目的**: AMSサブシステムの基本的なテストとコード品質チェック

**トリガー条件**:
- mainまたはdevelopブランチへのpush
- mainブランチへのプルリクエスト
- 関連ファイルの変更時のみ実行

**実行内容**:
1. リンターチェック（ruff, black）
2. 型チェック（mypy）
3. ユニットテスト（pytest）
4. カバレッジレポート（85%以上必須）

**特徴**:
- Python 3.10, 3.11, 3.12の複数バージョンでテスト
- 統合テストは除外（タイムアウト防止）
- Poetry依存関係のキャッシュ

### 2. 全サブシステムテストワークフロー（test-all-subsystems.yml）

**目的**: プロジェクト内の全サブシステムを網羅的にテスト

**トリガー条件**:
- メインCIワークフローと同じ

**実行内容**:

#### フェーズ1: サブシステム検出
- app/配下のpyproject.tomlを持つディレクトリを自動検出
- 動的にテストマトリックスを生成

#### フェーズ2: 各サブシステムのテスト
- 各サブシステムに対して独立してテスト実行
- リンター、型チェック、ユニットテスト
- サブシステムごとのカバレッジレポート

#### フェーズ3: 統合テスト（オプション）
- APIキーが設定されている場合のみ実行
- タイムアウト設定: 300秒
- 失敗してもワークフロー全体は停止しない

## 環境変数とシークレット

### 必須シークレット（統合テスト用）
- `OPENAI_API_KEY`: OpenAI APIキー
- `ANTHROPIC_API_KEY`: Anthropic APIキー  
- `GOOGLE_API_KEY`: Google APIキー
- `CODECOV_TOKEN`: Codecov連携用トークン

## テスト戦略

### ユニットテスト
- **実行環境**: CI/CD、ローカル開発環境
- **カバレッジ目標**: 85%以上（全サブシステムで統一）
- **タイムアウト**: 60秒/テスト

### 統合テスト
- **実行環境**: 専用ワークフロー、ローカル開発環境
- **特徴**: 実際のLLM APIを使用
- **注意事項**: APIコストが発生するため、小規模テストのみCI実行

### E2Eテスト
- **実行環境**: ローカル開発環境のみ
- **理由**: 長時間実行、高コスト

## トラブルシューティング

### よくある問題と解決策

1. **テストタイムアウト**
   - 原因: 統合テストがCI環境で実行されている
   - 解決: ユニットテストのみを実行するよう設定済み

2. **カバレッジ不足**
   - 原因: 新しいコードが追加されたがテストが不足
   - 解決: 該当モジュールのテストを追加

3. **依存関係エラー**
   - 原因: poetry.lockが更新されていない
   - 解決: `poetry lock --no-update`を実行してコミット

## ローカルでのテスト実行

### ユニットテストのみ
```bash
cd app/ams
poetry run pytest tests/unit/ -v
```

### 統合テストを含む全テスト
```bash
cd app/ams
poetry run pytest tests/ -v
```

### カバレッジレポート付き
```bash
cd app/ams
poetry run pytest tests/unit/ --cov=src --cov-report=html
```

## 今後の改善案

1. **並列実行の最適化**
   - pytest-xdistを使用した並列テスト実行

2. **キャッシュ戦略の改善**
   - より効率的な依存関係キャッシュ

3. **通知システムの実装**
   - テスト失敗時のSlack/Discord通知

4. **パフォーマンステストの追加**
   - 定期的なパフォーマンス計測とレポート

## 更新履歴

- 2025-08-03: 初版作成
  - メインCIワークフローの統合テスト除外
  - 全サブシステムテストワークフローの追加
  - ドキュメント作成