# URL分析要件定義

## 1. 目的
- 企業情報に関連するURLを高精度で特定する
- 最新の情報を確実に取得する

## 2. 機能要件

### 2.1 URL関連性分析
#### 2.1.1 分析対象
- サイトマップから取得したURL
- ナビゲーションメニューから取得したURL
- フッターリンクから取得したURL

#### 2.1.2 分析プロセス
1. URL構造解析
   - パスコンポーネントの分解（例: "/company/about/history" → ["company", "about", "history"]）
   - クエリパラメータの解析（例: "?lang=ja&category=corporate"）
   - 言語情報の特定（例: "/en/", "/ja/" などのパス情報）

2. LLMによる意味解析
   - 入力: 分解したURL情報
   - 処理: 
     - 各パスコンポーネントの意味理解
     - 企業情報との関連性判定
     - カテゴリ分類（会社概要、IR情報など）
   - 出力:
     - 関連性スコア（0-1の数値）
     - 判断理由（自然言語での説明）
     - ページカテゴリ

3. フィルタリング
   - 関連性スコアによる選別（0.4以上を関連ページとして抽出）
   - 重複コンテンツの除外
   - 外部ドメインの除外

#### 2.1.3 分析精度要件と評価方法
- 適合率（Precision）: 80%以上
  - 評価方法: 
    1. 抽出結果からランダムサンプリング（100件）
    2. 人手による正解ラベル付け
    3. 適合率の計算と分析
  - 定期的な精度評価（月1回）
  - 結果に基づくモデル調整

- 再現率（Recall）: 90%以上
  - 評価方法:
    1. 代表的な企業サイト（10サイト）の正解セット作成
    2. 分析結果との照合
    3. 再現率の計算と分析
  - 四半期ごとの総合評価
  - 未検出ページの分析とフィードバック

#### 2.1.4 分析結果
各URLに対して以下の情報を提供：
```json
{
    "url": "対象URL",
    "relevance_score": "関連性スコア（0-1）",
    "category": "ページカテゴリ（company_profile/corporate_info/ir_info等）",
    "reason": "判断理由の説明",
    "confidence": "判定の信頼度（0-1）"
}
```

### 2.2 情報の鮮度
- キャッシュを使用せず、常に最新の情報を取得
- 各URLに対して個別に評価を実施
- 性能最適化戦略：
  1. 効率的なURL構造解析
  2. LLMリクエストの最適化
  3. 並列処理の活用

### 2.3 並列処理
- 複数URLの同時評価
- サーバー負荷を考慮した同時接続数の制限
- 動的な同時実行数の調整

### 2.4 エラー処理戦略
#### 2.4.1 エラーの種類と対応
1. ネットワークエラー
   - リトライ戦略：指数バックオフ
   - 最大リトライ回数：3回
   - タイムアウト：30秒

2. LLMエラー
   - フォールバック戦略：
     1. 別のLLMモデルでの再試行
     2. ルールベースの簡易判定
   - エラーログの詳細記録
   - アラート通知（エラー率閾値超過時）

3. バリデーションエラー
   - 結果の異常値検知
   - エラーケースの分析と記録
   - 定期的なルール見直し

#### 2.4.2 エラー監視と改善
- エラー率の監視（種類別）
- エラーパターンの分析
- 定期的な改善策の実施

## 3. 非機能要件

### 3.1 性能要件と監視方法
- URL評価の応答時間
  - 要件：最大5秒/URL
  - 監視：
    1. 処理時間の計測（P50, P95, P99）
    2. タイムアウトの発生率
    3. ボトルネック分析

- 同時評価可能URL数
  - 要件：最大5件
  - 監視：
    1. 同時実行数の推移
    2. リソース使用率
    3. スループット

- パフォーマンス指標の収集
  1. メトリクスの定期収集
  2. ダッシュボード表示
  3. アラート設定

### 3.2 信頼性要件
- 誤判定率：5%以下
- LLM評価の信頼性スコア：0.8以上
- 定期的な精度評価と改善

### 3.3 拡張性要件
- 新しい企業情報カテゴリーへの対応
- 多言語サイトへの対応
- プラグイン方式の機能拡張

## 4. 制約条件
- robots.txtの遵守
- サイトのレート制限への対応
- クローリングの礼儀正しさ（politeness）の確保 