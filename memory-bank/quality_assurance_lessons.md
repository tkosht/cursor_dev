# å“è³ªä¿è¨¼ãƒ»æ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°é˜²æ­¢ã®æ•™è¨“

## ğŸ¯ ç›®çš„
æ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°ã®çµ¶å¯¾ç¦æ­¢ã¨ç§‘å­¦çš„å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ç¢ºç«‹ã«ã‚ˆã‚Šã€çœŸã®å“è³ªå‘ä¸Šã‚’å®Ÿç¾ã™ã‚‹ã€‚

## ğŸš¨ é‡å¤§ãªç™ºè¦‹äº‹é …ï¼ˆ2025-01-XXï¼‰

### æ¤œå‡ºã•ã‚ŒãŸæ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°ã®å®Ÿæ…‹
**å•é¡Œã®ç™ºè¦‹:**
- å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸: 92.6%
- å€‹åˆ¥ãƒ†ã‚¹ãƒˆå¹³å‡ã‚«ãƒãƒ¬ãƒƒã‚¸: 19.4%
- å·®åˆ†: 73.2%

**æ ¹æœ¬åŸå› :**
1. **ã‚¯ãƒ­ã‚¹ãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸ä¾å­˜**: å…¨ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«160å€‹ã®ãƒ†ã‚¹ãƒˆãŒç›¸äº’ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è£œå®Œ
2. **æ¸¬å®šæ–¹æ³•ã®å•é¡Œ**: `--cov=app`ã§å…¨appãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¸¬å®šå¯¾è±¡ã«ã—ã¦ã„ã‚‹
3. **èªè­˜ä¸è¶³**: å€‹åˆ¥ãƒ†ã‚¹ãƒˆã¯è‡ªåˆ†ã®è²¬ä»»ç¯„å›²ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆã™ã¹ãã¨ã„ã†æ­£ã—ã„è¨­è¨ˆåŸå‰‡ã®ç†è§£ä¸è¶³

**é‡è¦ãªèªè­˜:**
- å€‹åˆ¥ãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ã„ã®ã¯ **æ­£å¸¸ãªè¨­è¨ˆ**
- å„ãƒ†ã‚¹ãƒˆã¯è‡ªåˆ†ã®è²¬ä»»ç¯„å›²ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆã™ã¹ã
- å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸ã¨ã®ä¹–é›¢ã¯è¨­è¨ˆã®å¥å…¨æ€§ã‚’ç¤ºã™

## ğŸ”¬ ç§‘å­¦çš„å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ç¢ºç«‹

### è¨­è¨ˆåŸå‰‡
1. **æ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°çµ¶å¯¾ç¦æ­¢**
2. **å˜ä¸€æŒ‡æ¨™çµ¶å¯¾è¦–ã®æ’é™¤**
3. **ãƒ—ãƒ­ã‚»ã‚¹æ­£å½“æ€§ã®å¾¹åº•æ¤œè¨¼**
4. **ç§‘å­¦çš„æ‰‹æ³•ã«ã‚ˆã‚‹å®¢è¦³çš„è©•ä¾¡**

### æ¤œè¨¼é ˜åŸŸã®æ‹¡å¼µ
å¾“æ¥ã®åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯ã«åŠ ãˆã€ä»¥ä¸‹ã‚’å°å…¥ï¼š

#### 1. ã‚«ãƒãƒ¬ãƒƒã‚¸å“è³ªæ¤œè¨¼
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: ã‚«ãƒãƒ¬ãƒƒã‚¸æ•°å€¤ã®å†…éƒ¨æ•´åˆæ€§æ¤œè¨¼
- **è¨ˆç®—ç•°å¸¸æ¤œå‡º**: çµ±è¨ˆçš„æ‰‹æ³•ã«ã‚ˆã‚‹ç•°å¸¸å€¤æ¤œå‡º
- **ãƒ—ãƒ­ã‚»ã‚¹æ¤œè¨¼**: æ¸¬å®šæ–¹æ³•ã®å¦¥å½“æ€§ç¢ºèª

#### 2. ãƒ†ã‚¹ãƒˆå“è³ªåˆ†æ
- **ãƒ†ã‚¹ãƒˆåˆ†å¸ƒåˆ†æ**: unit/integration/e2eã®é©åˆ‡ãªæ¯”ç‡ç¢ºèª
- **ãƒ†ã‚¹ãƒˆè¦æ¨¡æ¤œè¨¼**: ååˆ†ãªãƒ†ã‚¹ãƒˆæ•°ã®ç¢ºä¿
- **ãƒ†ã‚¹ãƒˆè¨­è¨ˆå“è³ª**: è²¬ä»»ç¯„å›²ã®é©åˆ‡æ€§è©•ä¾¡

#### 3. ãƒ—ãƒ­ã‚»ã‚¹æ•´åˆæ€§æ¤œè¨¼
- **æ¸¬å®šæ™‚é–“å¦¥å½“æ€§**: ååˆ†ãªæ¤œè¨¼æ™‚é–“ã®ç¢ºä¿
- **ç§‘å­¦çš„ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°**: å±¤åŒ–ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ä»£è¡¨æ€§ç¢ºä¿
- **ãƒ‡ãƒ¼ã‚¿åé›†ä¿¡é ¼æ€§**: è¤‡æ•°æ‰‹æ³•ã«ã‚ˆã‚‹æ¤œè¨¼

## ğŸ’¡ å…·ä½“çš„æ”¹å–„æ‰‹æ³•

### æ—§ã‚·ã‚¹ãƒ†ãƒ ã®å•é¡Œç‚¹
```python
# å•é¡Œã®ã‚ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
threshold_ratio = 0.5  # æ£æ„çš„ãªé–¾å€¤
sample_classes = test_classes[:5]  # ä¸é©åˆ‡ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
if coverage_gap > (overall_coverage * threshold_ratio):  # å˜ç´”ãªæ¯”è¼ƒ
```

### æ–°ã‚·ã‚¹ãƒ†ãƒ ã®ç§‘å­¦çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
```python
# ç§‘å­¦çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- çµ±è¨ˆçš„ç•°å¸¸æ¤œå‡ºï¼ˆå¹³å‡å€¤ã€æ¨™æº–åå·®ã«ã‚ˆã‚‹å®¢è¦³çš„åˆ¤å®šï¼‰
- å±¤åŒ–ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆä»£è¡¨æ€§ã®ã‚ã‚‹æ¨™æœ¬æŠ½å‡ºï¼‰
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§æ¤œè¨¼ï¼ˆå†…éƒ¨ä¸€è²«æ€§ã®ç¢ºèªï¼‰
- å¤šæ¬¡å…ƒå“è³ªè©•ä¾¡ï¼ˆè¤‡æ•°æŒ‡æ¨™ã«ã‚ˆã‚‹ç·åˆåˆ¤å®šï¼‰
```

## ğŸ“‹ çµ¶å¯¾çš„ãƒ«ãƒ¼ãƒ«ã®ç¢ºç«‹

### Rule 1: æ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°çµ¶å¯¾ç¦æ­¢
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ä¸Šã’ã‚‹ãŸã‚ã«æœ¬æ¥ã™ã¹ããƒ†ã‚¹ãƒˆã‚’é¿ã‘ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢
- çŸ­æœŸçš„ãªæ•°å€¤æ”¹å–„ã®ãŸã‚ã«æ ¹æœ¬çš„ãªå“è³ªã‚’çŠ ç‰²ã«ã—ãªã„
- æ¸¬å®šæ–¹æ³•ã®å¤‰æ›´ã«ã‚ˆã‚‹è¦‹ã‹ã‘ä¸Šã®æ”¹å–„ã¯èªã‚ãªã„

### Rule 2: å˜ä¸€æŒ‡æ¨™çµ¶å¯¾è¦–ã®æ’é™¤
- ã‚«ãƒãƒ¬ãƒƒã‚¸æ•°å€¤ã®ã¿ã§ã®å“è³ªåˆ¤å®šã¯ç¦æ­¢
- è¤‡æ•°ã®å“è³ªæŒ‡æ¨™ã«ã‚ˆã‚‹ç·åˆçš„ãªè©•ä¾¡ã‚’ç¾©å‹™åŒ–
- æŒ‡æ¨™ã®èƒŒæ™¯ã«ã‚ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®å¥å…¨æ€§ã‚’é‡è¦–

### Rule 3: ãƒ—ãƒ­ã‚»ã‚¹æ­£å½“æ€§ã®å¾¹åº•æ¤œè¨¼
- ã™ã¹ã¦ã®å“è³ªæ¸¬å®šãƒ—ãƒ­ã‚»ã‚¹ã¯ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã
- æ£æ„çš„ãªé–¾å€¤è¨­å®šã¯ç¦æ­¢
- æ¸¬å®šæ–¹æ³•ã®å¦¥å½“æ€§ã‚’å¸¸ã«æ¤œè¨¼

### Rule 4: ç¶™ç¶šçš„æ”¹å–„ã®ç¾©å‹™åŒ–
- å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®å“è³ªå‘ä¸Šã‚’ç¶™ç¶š
- æ–°ãŸãªæ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°æ‰‹æ³•ã®æ¤œå‡ºãƒ»å¯¾ç­–ã‚’å®Ÿè£…
- æ•™è¨“ã®çµ„ç¹”çš„å…±æœ‰ã¨æ´»ç”¨

## ğŸ›¡ï¸ æ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ 

### æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
1. **ã‚¯ãƒ­ã‚¹ãƒ†ã‚¹ãƒˆä¾å­˜**: å€‹åˆ¥ãƒ†ã‚¹ãƒˆã¨å…¨ä½“ãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸ä¹–é›¢
2. **æ¸¬å®šæ–¹æ³•æ“ä½œ**: ã‚«ãƒãƒ¬ãƒƒã‚¸å¯¾è±¡ç¯„å›²ã®æ£æ„çš„å¤‰æ›´
3. **é–¾å€¤æ“ä½œ**: å“è³ªåŸºæº–ã®æ£æ„çš„ç·©å’Œ
4. **çµ±è¨ˆæ“ä½œ**: ç•°å¸¸å€¤ã®é™¤å¤–ã«ã‚ˆã‚‹è¦‹ã‹ã‘ä¸Šã®æ”¹å–„

### å¯¾ç­–ã‚·ã‚¹ãƒ†ãƒ 
- **è‡ªå‹•æ¤œå‡º**: çµ±è¨ˆçš„æ‰‹æ³•ã«ã‚ˆã‚‹ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
- **ãƒ—ãƒ­ã‚»ã‚¹ç›£æŸ»**: æ¸¬å®šæ–¹æ³•ã®å¤‰æ›´å±¥æ­´è¿½è·¡
- **å¤šé‡æ¤œè¨¼**: è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸæ‰‹æ³•ã«ã‚ˆã‚‹æ¤œè¨¼
- **é€æ˜æ€§ç¢ºä¿**: å…¨æ¸¬å®šãƒ—ãƒ­ã‚»ã‚¹ã®å¯è¦–åŒ–ãƒ»è¨˜éŒ²

## ğŸ“ˆ æˆåŠŸäº‹ä¾‹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ç¾ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æˆæœ
- ã‚«ãƒãƒ¬ãƒƒã‚¸92.6%ã‚’å¥å…¨ãªæ–¹æ³•ã§é”æˆ
- 160å€‹ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹åŒ…æ‹¬çš„æ¤œè¨¼
- é©åˆ‡ãªãƒ†ã‚¹ãƒˆåˆ†æ•£ï¼ˆunit/integration/e2eï¼‰
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºä¿

### æ¨å¥¨ã•ã‚Œã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
1. **æ®µéšçš„å“è³ªå‘ä¸Š**: æ€¥æ¿€ãªæ•°å€¤æ”¹å–„ã‚ˆã‚Šã‚‚æŒç¶šçš„ãªæ”¹å–„
2. **æ ¹æœ¬åŸå› è§£æ±º**: è¡¨é¢çš„ãªå¯¾ç—‡ç™‚æ³•ã§ã¯ãªãæ ¹æœ¬çš„è§£æ±º
3. **é€æ˜æ€§é‡è¦–**: ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¯è¦–åŒ–ãƒ»æ¤œè¨¼å¯èƒ½ã«
4. **æ•™è¨“æ´»ç”¨**: éå»ã®å¤±æ•—ã‹ã‚‰å­¦ã³ã€åŒã˜éã¡ã‚’ç¹°ã‚Šè¿”ã•ãªã„

## ğŸ¯ ä»Šå¾Œã®è¡Œå‹•æŒ‡é‡

### å³æ™‚å®Ÿæ–½äº‹é …
- [x] å³æ ¼å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ  v2.0ã®å®Ÿè£…å®Œäº†
- [ ] å¤±æ•—ã—ã¦ã„ã‚‹1ã¤ã®ãƒ†ã‚¹ãƒˆã®ä¿®å¾©
- [ ] å€‹åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®å•é¡Œä¿®æ­£
- [ ] å“è³ªä¿è¨¼ãƒ—ãƒ­ã‚»ã‚¹ã®æ–‡æ›¸åŒ–

### ä¸­æœŸçš„æ”¹å–„
- [ ] å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå‹•åŒ–å¼·åŒ–
- [ ] ãƒãƒ¼ãƒ å†…ã§ã®å“è³ªä¿è¨¼æ–‡åŒ–ã®æµ¸é€
- [ ] å¤–éƒ¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®çŸ¥è¦‹å±•é–‹
- [ ] ç¶™ç¶šçš„ãªæ”¹å–„ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºç«‹

### é•·æœŸçš„æˆ¦ç•¥
- [ ] çµ„ç¹”å…¨ä½“ã§ã®å“è³ªä¿è¨¼æ¨™æº–åŒ–
- [ ] æ¥­ç•Œãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¸ã®è²¢çŒ®
- [ ] æ–°æŠ€è¡“å°å…¥æ™‚ã®å“è³ªä¿è¨¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ç¢ºç«‹
- [ ] å“è³ªä¿è¨¼ã®è‡ªå‹•åŒ–ãƒ»AIæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `scripts/quality_gate_check.py`: å³æ ¼å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ  v2.0
- `memory-bank/progress.md`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—è¨˜éŒ²
- `memory-bank/activeContext.md`: ç¾åœ¨ã®ä½œæ¥­çŠ¶æ³

---

**ä½œæˆæ—¥**: 2025-01-XX  
**æœ€çµ‚æ›´æ–°**: æ•°å€¤ãƒãƒƒã‚­ãƒ³ã‚°å•é¡Œç™ºè¦‹ãƒ»å¯¾ç­–å®Œäº†æ™‚  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš¨ é‡è¦æ•™è¨“ - å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å‚ç…§å¿…é ˆ 

##  Lessons Learned from Real Incidents (æ–°è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³)

### Case Study: The Misleading API Key Incident (2025-05-31)

**Incident Summary:**
- **Initial Symptom:** E2E tests consistently failed with generic error messages, sometimes hinting at API key issues after an accidental `.env` display by the AI.
- **Misdirection:** The AI (myself) and the user initially focused heavily on API key validity and configuration, as this was a known security breach.
- **True Root Cause:** After extensive logging and iterative debugging, the actual problem was identified as overly aggressive API timeouts (5 seconds) for Gemini 2.5 Pro, and later, safety filter activations by the API for anodyne prompts.
- **Contributing Factor:** Insufficiently detailed logging and error message masking in higher-level exception handlers obscured the true nature of the API responses (e.g. `finish_reason=2` for safety filters).

**Key Lessons for Quality Assurance & Numerical Hacking Prevention:**
1.  **Don't Be Blinded by Obvious Suspects:** While the API key leak was a critical security issue that needed addressing, it became a red herring that distracted from the true *technical* root cause of the test failures. A compromised key might lead to `API_KEY_INVALID` errors, but the observed timeouts and safety filter responses were distinct issues.
2.  **Detailed Telemetry is Crucial:** The breakthrough came when logging was enhanced to show: 
    *   Exact API `finish_reason` codes.
    *   Precise timing of API calls, revealing timeouts.
    *   Full propagation of specific error types instead of generic messages.
3.  **Holistic Error Analysis:** Quality assurance must look beyond simple pass/fail. The *reason* for failure, especially with external dependencies, is key. Had the system initially reported "Safety Filter Activated" instead of a generic error, debugging would have been faster.
4.  **Test System Robustness vs. External API Behavior:** E2E tests for AI services must anticipate behaviors like safety filtering. The test harness itself needed improvements (retry with safer prompts) to distinguish true application failures from expected API protective measures.

**Systemic Improvements Implemented:**
- Enhanced logging in `GeminiClient` to capture `finish_reason` and detailed error context.
- Improved error propagation to ensure specific API error details reach test assertion levels.
- Updated E2E test helpers to correctly classify errors based on propagated details (not just localized strings) and implement smarter retry logic for safety filters.

This incident underscores that high-level metrics (like test pass/fail rates or even overall coverage) can be misleading if not supported by deep, granular telemetry and a robust understanding of the system's interaction with its dependencies. Preventing numerical hacking also means ensuring that the numbers (metrics) accurately reflect the true state and behavior of the system. 