# E2Eテスト設計ガイドライン (特に外部API連携)

## 🎯 目的
外部APIとの連携を含むエンドツーエンド (E2E) テストの信頼性、安定性、保守性を高める。

## 共通原則

1.  **テストの独立性と冪等性:**
    *   各E2Eテストは他のテストから独立しており、実行順序に依存しないようにする。
    *   テストは何度実行しても同じ結果になる（冪等性を持つ）ように設計する。外部APIの状態変化に依存しすぎない工夫が必要。

2.  **実環境に近いテスト環境:**
    *   可能な限り本番環境に近い設定、データ、インフラでテストを実行する。
    *   ただし、コストや安定性の観点から、全てのケースで実APIを叩くわけではない（下記「モックと実APIの使い分け」参照）。

3.  **テストスコープの明確化:**
    *   E2Eテストで何を検証し、何を検証しないのか（ユニットテストや結合テストの範囲との切り分け）を明確にする。
    *   ビジネスロジックの主要な流れ、クリティカルパス、主要な統合ポイントを重点的にテストする。

## 外部API連携特有の考慮事項

### 1. 外部APIの挙動理解と対策
*   **レート制限:** APIの利用回数制限を把握し、テスト実行頻度を調整するか、モックを使用する。
*   **セーフティフィルター (AI APIなど):** AIが生成するコンテンツには、予期せぬフィルタリング（有害コンテンツ、個人情報など）がかかる可能性があることを理解する。
    *   **対策:** 
        *   テスト用の安全な入力プロンプトを用意する。
        *   フィルター作動を検知し、代替プロンプトでリトライするロジックをテストヘルパーに実装する (今回のGemini API事例参照)。
        *   フィルター作動自体が期待される動作であるケースも考慮する。
*   **一時的なネットワークエラー/サーバーエラー:** `50x`系エラーなど、一時的な問題が発生する可能性を考慮する。
*   **API仕様変更:** 外部APIの仕様は変更される可能性があるため、定期的なテストの見直しとメンテナンスが必要。
*   **データ依存性:** 特定のデータ状態に依存するAPIの場合、テストデータの準備とクリーンアップ戦略が重要。

### 2. 堅牢なエラー処理とリトライ機構
*   **タイムアウト設定:** 外部APIの平均的・最大応答時間を考慮し、現実的かつ適切なタイムアウト値を設定する。
    *   短すぎるタイムアウトは不必要なテスト失敗を招く (今回のGemini API事例参照)。
*   **リトライロジック:** 一時的なエラー（ネットワークエラー、レート制限の一部など）に対しては、リトライ機構を実装する。
    *   指数バックオフやジッターを取り入れ、APIサーバーへの負荷を軽減する。
    *   最大リトライ回数を設定し、無限ループを避ける。
    *   リトライすべきエラーとそうでないエラー（認証エラー、致命的な設定ミスなど）を区別する。
*   **サーキットブレーカー:** 連続してAPIエラーが発生する場合、一時的にAPI呼び出しを停止し、システム全体の安定性を保つ機構の導入を検討する。

### 3. モックと実APIの戦略的な使い分け
*   **全て実APIの危険性:** コスト増大、テストの不安定化、実行時間長期化、外部APIへの過度な負荷。
*   **モックの活用:**
    *   **安定性確保:** 外部APIの不安定な挙動からテストを隔離する。
    *   **特定ケースの再現:** エラーケースやエッジケースを確実に再現する。
    *   **実行速度向上:** API呼び出しを伴わないため高速。
    *   **コスト削減:** 有料APIの呼び出し回数を削減する。
*   **実APIテストの必要性:**
    *   **真の統合検証:** 実際のAPIとの契約（リクエスト/レスポンス形式、認証など）が正しく機能するかを確認する。
    *   **環境差異の検出:** ステージング環境や本番環境でのみ発生する問題を検出する。
*   **戦略:**
    *   基本的なロジック、正常系パスの大部分はモックを使用して高速かつ安定的にテストする。
    *   主要な統合ポイント、認証処理、代表的な正常系・異常系シナリオについては、実APIを使用したテストを限定的に実施する（スモークテスト、サニティテストとして）。
    *   CI環境ではモック中心、特定環境（ステージングなど）でのみ実APIテストを実行するなどの使い分けも有効。

### 4. 詳細かつ構造化されたテストログ
*   **テスト実行コンテキスト:** テスト名、実行日時、環境情報。
*   **APIリクエスト情報:** エンドポイント、ヘッダー（認証情報はマスク）、主要なリクエストパラメータ。
*   **APIレスポンス情報:** ステータスコード、レスポンスボディの主要部分、`finish_reason`などのメタデータ。
*   **アサーション詳細:** 何を期待し、実際は何だったのか。
*   **エラー発生時の詳細:** エラーメッセージ、スタックトレース、分類されたエラー種別。
*   **リトライ情報:** リトライ回数、試行した代替入力など。
*   ログレベルを適切に使い分け、通常はINFOレベル、問題発生時やデバッグ時にはDEBUGレベルで詳細情報を確認できるようにする。

### 5. エラー分類の正確性と堅牢性
*   **ローカライズメッセージへの非依存:** テスト内のエラー分類ロジックは、APIが返す可能性のあるユーザー向けエラーメッセージ（特にローカライズされている場合）の文字列解析に依存しないようにする。
    *   APIが提供するエラーコード、ステータスコード、`finish_reason`などの構造化された情報を優先的に使用する。
    *   やむを得ず文字列を解析する場合でも、複数の言語パターンや正規表現を考慮し、変更に強い設計にする。
*   **明確なエラー種別の定義:** テストヘルパー内で、外部API起因のエラー種別（`RATE_LIMIT`, `SAFETY_FILTER`, `API_KEY_INVALID`, `TIMEOUT`など）を明確に定義し、それに基づいてテストの挙動（リトライ、スキップ、失敗など）を制御する。

## ✅ 今回のGemini API E2Eテスト改善事例からの学び

1.  **タイムアウトの現実的な設定:** AIモデルの応答時間は変動するため、ある程度の余裕を持ったタイムアウト設定（例: 5秒→15秒）が必要だった。
2.  **セーフティフィルターへの対応:** 単純なプロンプトでもセーフティフィルターが作動する可能性を考慮し、検知・リトライ（代替プロンプト使用）の仕組みをテストヘルパーに導入した。
3.  **エラー情報の正確な伝播:** `GeminiClient`で検知した具体的なエラー情報（`finish_reason`に基づくエラー種別）が、`GeminiAgent`を経由してE2Eテストヘルパーまで失われずに伝播するよう修正した。
4.  **テストヘルパーのエラー分類改善:** 当初、E2Eテストヘルパーが日本語のユーザー向けメッセージ内の英語キーワードでエラーを分類しようとしていたが、これを修正し、より多くのパターン（日本語キーワード含む）でセーフティフィルターを認識できるようにした。
5.  **詳細ログの威力:** DEBUGレベルでの詳細なログ出力（APIリクエスト・レスポンス、`finish_reason`、内部状態など）が、これらの複雑な問題を特定し解決する上で決定的な役割を果たした。

---
**最終更新:** 2025-05-31 (Gemini API E2Eテストデバッグの教訓を反映) 