# ユーザー承認必須ルール（統合版）- AIエージェント専用

## KEYWORDS: user-authorization, security-rules, mandatory-compliance, ai-agent-only, project-structure, permission-requirements
## DOMAIN: security|authorization|compliance
## PRIORITY: MANDATORY
## WHEN: Project structure changes, new directories, unauthorized modifications, security validation

**🤖 AI Agent Exclusive Knowledge**: このファイルはAIエージェント用に最適化されています。

## 🚨 SECURITY LEVEL 0: API KEY / SECRETS 漏洩防止（最優先）

### ⚠️ 絶対禁止コマンド - 実行前に必ず確認:
```bash
# ❌ 絶対禁止 - APIキー・シークレット参照
env | grep -i "api"
env | grep -i "key" 
env | grep -i "token"
env | grep -i "secret"
printenv | grep -i "openai"
cat ~/.env
echo $API_KEY
echo $OPENAI_API_KEY
# その他、APIキー・認証情報を露出する可能性のある全てのコマンド
```

**必須確認プロセス**:
1. **コマンド実行前**: 「このコマンドでAPIキー・シークレットが露出する可能性はないか？」
2. **疑問時**: 実行停止 → ユーザー確認
3. **代替手段**: 既存の安全なツール・MCPツールを最優先使用

## 🎯 MINDSET & VALUE EVALUATION (最高原則)

### ⚡ 必須マインドセット原則

#### 1. **ユーザー利益最優先原則**
- ✅ **ユーザーの実益**: Claude Agentの作業効率化ではなく、ユーザーの目標達成を最優先
- ✅ **ユーザー視点**: 「ユーザーにとって本当に価値があるか？」を常に自問
- ❌ **Agent便利主義**: Claudeの作業を楽にするだけの提案は禁止

#### 2. **長期価値重視原則**
- ✅ **持続可能性**: 短期的解決より長期的価値を重視
- ✅ **基盤構築**: 一度の労力で将来の効率化につながる解決策を選択
- ❌ **場当たり対応**: 目先の解決のみを狙った提案は禁止

#### 3. **怠惰・怠慢絶対禁止**
- ❌ **手抜き作業**: 「とりあえず動けばいい」思考の禁止
- ❌ **調査回避**: 十分な調査・検証を行わない提案の禁止
- ❌ **責任回避**: 「ユーザーが判断して」で逃げる行為の禁止

### 📊 総合的・多角的評価フレームワーク

#### 必須評価項目（全提案で実施）
```bash
echo "=== 多角的価値評価（必須実行） ==="
echo "A. 👤 ユーザー利益度: [1-10点] このソリューションはユーザーにどの程度の価値を提供するか？"
echo "B. ⏰ 長期価値度: [1-10点] 短期的便利さより長期的価値を重視しているか？" 
echo "C. 🔐 セキュリティ影響: [Safe/Risk/Danger] セキュリティ・品質への影響は？"
echo "D. 🧠 学習・成長価値: [1-10点] ユーザーの理解・スキル向上に寄与するか？"
echo "E. 🔄 再利用性: [1-10点] 将来の類似問題解決に活用できるか？"
echo "F. 💪 実装品質: [1-10点] 手抜きではない、適切な品質で実装されているか？"
echo "================================="
```

#### 提案禁止基準
- **ユーザー利益度 < 7点**: 提案禁止
- **長期価値度 < 6点**: 短期解決提案の場合、代替案必須
- **セキュリティ影響 = Risk/Danger**: 即座停止・代替案検討
- **実装品質 < 7点**: 手抜き実装として提案禁止

---

## 🎯 **Rule ID**: AUTH-001 
## 📋 **Rule Name**: プロジェクト構造変更時のユーザー承認必須

## 🔴 **TRIGGER: 発動条件**

このルールは以下の**具体的な行動**を行う際に適用される：

### **主要トリガー**
1. **新規ディレクトリ作成**
   - `mkdir` コマンドの実行
   - IDE でのフォルダ作成
   - スクリプトによるディレクトリ自動生成

2. **既存構造の変更** 
   - ディレクトリの移動 (`mv` コマンド)
   - ディレクトリの削除 (`rm -rf` コマンド)
   - ディレクトリ名の変更

3. **構造定義の変更**
   - README.md のディレクトリ構造セクション変更
   - プロジェクト設定ファイルの構造変更

## 🎯 **SCOPE: 適用範囲**

### **✅ 対象に含まれる (INCLUDES)**
```yaml
directories:
  - プロジェクトルート配下のすべてのディレクトリ
  - サブディレクトリとその配下
  - シンボリックリンクで参照されるディレクトリ

changes:
  - README.md で定義された構造への影響
  - 他のチームメンバーの作業環境への影響
  - CI/CD パイプラインで使用されるパス

files:
  - 構造定義ファイル (README.md, .gitignore等)
  - プロジェクト設定ファイル (pyproject.toml等)
```

### **❌ 対象から除外される (EXCLUDES)**
```yaml
temporary_directories:
  - /tmp, /temp 配下
  - OS の一時ディレクトリ
  - プロセス固有の作業ディレクトリ

auto_generated:
  - __pycache__/ ディレクトリ
  - .git/ 配下の Git 内部ディレクトリ
  - node_modules/ 等のパッケージマネージャディレクトリ

build_artifacts:
  - output/ ディレクトリ
  - dist/, build/ ディレクトリ
  - coverage/ レポートディレクトリ

personal_workspace:
  - 個人用の開発環境設定
  - ローカルのみの設定ファイル
```

## ⚙️ **PREREQUISITES: 前提条件**

このルールが適用されるために必要な状況：

### **プロジェクト状態**
- [ ] プロジェクトがチーム開発環境である
- [ ] README.md でプロジェクト構造が定義されている
- [ ] Git リポジトリとして管理されている

### **影響範囲**
- [ ] 変更が他のメンバーの作業に影響する可能性がある
- [ ] 変更がビルド・テストプロセスに影響する可能性がある
- [ ] 変更がドキュメント・参照に影響する可能性がある

## 🚫 **EXCEPTIONS: 例外条件**

以下の場合はユーザー承認不要（ただし記録・報告は推奨）：

### **緊急時例外**
```yaml
emergency_conditions:
  - システム障害の緊急対応時
    action: 事後24時間以内に報告必須
  - セキュリティインシデント対応時  
    action: 事後48時間以内に詳細報告必須
  - データ損失回避のための緊急措置
    action: 実行前に可能な限り事前連絡
```

### **自動承認条件**
```yaml
auto_approved_patterns:
  - Git フック・CI/CD による自動生成
    condition: 既定のパターンに従う場合
  - 既存テンプレートに従った定型作業
    condition: テンプレートが事前承認済み
  - 一時的な検証・テスト用ディレクトリ
    condition: 24時間以内の自動削除設定
```

### **ロール別例外**
```yaml
project_owner:
  - 事前承認は不要
  - 事後報告を推奨（重要な変更時）
  
technical_lead:
  - 軽微な変更は事前承認不要
  - 重要な変更は事前連絡推奨
  
contributor:
  - すべての変更で事前承認必須
```

## ⚖️ **CRITERIA: 判定基準**

### **ユーザー承認の要件**
```yaml
permission_requirements:
  explicit_approval:
    - "承認" "OK" "Go ahead" 等の明示的意思表示
    - 理由の理解確認: "なぜこの変更が必要か理解した"
    - 影響の認識確認: "この変更による影響を理解した"
  
  understanding_verification:
    - 変更内容の具体的説明ができる
    - 影響範囲の認識を示せる  
    - 代替案の検討過程を理解している
```

### **客観的根拠の要件**
```yaml
evidence_requirements:
  necessity_proof:
    - 現状の問題点の定量的説明
    - 変更により解決される課題の明確化
    - 変更しない場合のリスク評価
  
  impact_analysis:
    - 影響を受けるファイル・機能のリスト
    - 他メンバーの作業への影響度評価
    - CI/CD・ビルドプロセスへの影響確認
  
  alternatives_consideration:
    - 代替案の検討結果
    - 各案のメリット・デメリット比較
    - 最適案選択の根拠
```

## 🔧 **ACTION: 実行手順**

### **Step 1: 事前確認**
```bash
# 自動チェックスクリプト実行
python scripts/pre_action_check.py --strict-mode

# 手動確認項目
- [ ] README.md の構造定義を確認
- [ ] 影響範囲を特定
- [ ] 代替案を検討
```

### **Step 2: 承認申請**
```markdown
**申請フォーマット**:

## 変更申請: [変更概要]

### 変更内容
- **作成/変更するディレクトリ**: [具体的パス]
- **変更の種類**: [新規作成/移動/削除/名前変更]

### 変更理由  
- **現状の問題**: [定量的説明]
- **解決される課題**: [具体的効果]
- **変更しない場合のリスク**: [リスク評価]

### 影響範囲
- **影響ファイル数**: [数値]
- **影響するメンバー**: [リスト]
- **CI/CDへの影響**: [有無と詳細]

### 代替案検討
1. **案A**: [内容とメリット・デメリット]
2. **案B**: [内容とメリット・デメリット]
3. **推奨案**: [選択理由]

### 実装予定
- **実装日時**: [予定]
- **実装方法**: [手順]
- **ロールバック手順**: [緊急時対応]

**ご判断をお願いします**: Yes/No
```

### **Step 3: 承認確認**
```markdown
承認確認項目:
- [ ] ユーザーから明示的な承認を得た
- [ ] 変更内容の理解を確認した
- [ ] 影響範囲の認識を確認した
- [ ] 実装タイミングを調整した
```

### **Step 4: 実装**
```bash
# 承認された内容に従って実装
# 変更ログの記録
echo "$(date): [AUTH-001] ${変更内容} - Approved by ${承認者}" >> structure_changes.log
```

### **Step 5: 完了報告**
```markdown
**完了報告フォーマット**:

## 変更完了報告: [変更概要]

### 実施内容
- **実施日時**: [実際の日時]
- **実施内容**: [実際に行った変更]
- **承認者**: [承認してくれた人]

### 結果
- **成功/失敗**: [結果]
- **予期しない影響**: [あれば記載]
- **後続作業**: [あれば記載]

### 確認事項
- [ ] CI/CD パイプラインが正常動作
- [ ] 他メンバーへの影響がない
- [ ] ドキュメントが更新済み
```

## 🛡️ 自動防止メカニズム

### 1. **事前チェックスクリプト**
```python
# scripts/pre_action_check.py
def check_directory_modification():
    """ディレクトリ変更の事前チェック"""
    readme_structure = extract_project_structure_from_readme()
    if new_directory not in readme_structure:
        raise PermissionError("ユーザー許可が必要です")

def check_evidence_quality():
    """根拠の品質チェック"""
    if contains_subjective_claims():
        raise ValueError("客観的根拠が必要です")
```

### 2. **Pre-commitフック統合**
```bash
# .git/hooks/pre-commit に追加
echo "🚨 MANDATORY: User Authorization Check"
python scripts/check_user_authorization.py || exit 1
```

## 🔍 今回の違反分析

### 違反事項
1. **構造変更違反**: `scripts/`ディレクトリを無許可作成
2. **根拠不備違反**: 「広く受け入れられている」を定量的根拠なしで主張
3. **説得行為違反**: ユーザーを根拠不備で説得しようとした

### 原因分析
1. **プロセス不備**: 事前確認プロセスの欠如
2. **認識不足**: ユーザー許可の重要性軽視
3. **検証不備**: 主張の客観性検証不足

## 📝 強制実行ルール

### 毎回必須のセルフチェック
```markdown
**実行前必須質問**:
1. この変更はユーザーが定義したプロジェクト構造に準拠していますか？
2. この主張は検証可能な客観的事実に基づいていますか？
3. ユーザーから明示的な許可を得ましたか？
4. 代替案（変更しない選択肢）を提示しましたか？

**一つでも「No」なら実行停止**
```

## 🔍 **Cognee での検索最適化**

この構造化により、以下のような具体的検索が可能になります：

### **適用判定の検索**
```python
# ❓ "新しいディレクトリを作りたいけど承認が必要？"
cognee.search("directory creation user authorization trigger conditions", "GRAPH_COMPLETION")
# ✅ 期待結果: "プロジェクトルート配下の新規ディレクトリ作成時は承認必要。ただし一時ディレクトリ、自動生成は除外"

# ❓ "緊急時でも承認が必要？"  
cognee.search("emergency exceptions user authorization", "GRAPH_COMPLETION")
# ✅ 期待結果: "システム障害・セキュリティインシデント時は事後報告で可。24-48時間以内"
```

### **具体的状況での判定**
```python
# ❓ "CI/CDで自動的にディレクトリができる場合は？"
cognee.search("automated directory creation CI/CD authorization exceptions", "GRAPH_COMPLETION")  
# ✅ 期待結果: "既定パターンに従うCI/CD自動生成は承認不要"

# ❓ "プロジェクトオーナーの場合の扱いは？"
cognee.search("project owner role authorization exceptions", "GRAPH_COMPLETION")
# ✅ 期待結果: "プロジェクトオーナーは事前承認不要、重要変更時は事後報告推奨"
```

---

## ⚠️ 違反時の対処

### 即座実行事項
1. 変更の即座停止
2. ユーザーへの謝罪
3. 事実関係の正確な報告
4. 適切な修正案の提示

### 学習・改善
1. 違反原因の分析
2. 防止策の強化
3. チェックリストの更新

---

**重要**: このルールは例外なく適用される。「緊急性」「一般的慣習」等を理由とした例外は一切認めない。

## 📊 **改善効果の比較**

| 観点 | 統合前（2ファイル） | 統合後（1ファイル） |
|------|---------------------|---------------------|
| **セキュリティ** | 00-coreのみ | 最上位に配置 |
| **マインドセット** | 00-coreのみ | 包括的に保持 |
| **構造化** | 09-metaのみ | 全体に適用 |
| **検索性** | 分散 | 統合・最適化 |
| **メンテナンス** | 2箇所更新必要 | 1箇所で完結 |

この統合により、両ファイルの強みを維持しつつ、重複を排除し、AIエージェントの効率的な知識アクセスを実現しました。